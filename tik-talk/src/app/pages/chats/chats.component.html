<!-- chats.component.html -->
<div class="chat">
  <div class="chat__left">
    <div class="search">
      <input
        type="text"
        placeholder="Искать..."
        [(ngModel)]="searchQuery"
        (ngModelChange)="searchChats()"
      />
      <div
        class="close"
        *ngIf="searchQuery"
        (click)="searchQuery = ''; searchChats()"
      >
        <svg width="12" height="12" viewBox="0 0 12 12">
          <path d="M1 1L11 11M1 11L11 1" stroke="#999" stroke-width="2" />
        </svg>
      </div>
    </div>
    <div class="chats">
      <ng-container *ngIf="!loading; else loadingTemplate">
        <div
          *ngFor="let chat of chats"
          class="chats__one"
          [class.active]="selectedChat?._id === chat._id"
          (click)="selectChat(chat)"
        >
          <div class="avatar">
            <img [src]="getChatAvatar(chat)" alt="avatar" />
            <span
              class="status"
              [class.online]="
                getUserStatus(
                  chat.user_send._id === currentUserId
                    ? chat.user_get._id
                    : chat.user_send._id
                ).isOnline
              "
            ></span>
          </div>
          <div class="chat__file">
            <div class="chat__top">
              <p>{{ getChatTitle(chat) }}</p>
              <span>{{ chat.updatedAt | date : "dd.MM.yyyy" }}</span>
            </div>
            <div class="chat__bottom">
              <p>{{ chat.lastMessage?.content || "Нет сообщений" }}</p>
              <span *ngIf="chat.unreadCount" class="unread-count">
                {{ chat.unreadCount }}
              </span>
            </div>
          </div>
        </div>
      </ng-container>
      <ng-template #loadingTemplate>
        <div class="loading">Загрузка чатов...</div>
      </ng-template>
    </div>
  </div>
  <div class="chat__right" *ngIf="selectedChat">
    <div class="chat__right-header">
      <button (click)="selectedChat = null">
        <svg width="6" height="8" viewBox="0 0 6 8">
          <path
            d="M5.28125 0.9375L2.21875 4L5.28125 7.0625L4.34375 8L0.34375 4L4.34375 0L5.28125 0.9375Z"
            fill="white"
          />
        </svg>
      </button>
      <div class="user__info">
        <div class="avatar">
          <img [src]="getChatAvatar(selectedChat)" alt="avatar" />
        </div>
        <span>{{ getChatTitle(selectedChat) }}</span>
        <span
          class="status-text"
          *ngIf="
            !getUserStatus(
              selectedChat.user_send._id === currentUserId
                ? selectedChat.user_get._id
                : selectedChat.user_send._id
            ).isOnline
          "
        >
          {{
            getUserStatus(
              selectedChat.user_send._id === currentUserId
                ? selectedChat.user_get._id
                : selectedChat.user_send._id
            ).lastSeen | date : "dd.MM.yyyy HH:mm"
          }}
        </span>
      </div>
      <button class="options">
        <svg width="4" height="12" viewBox="0 0 4 12">
          <path
            d="M1.0625 9.0625C1.33333 8.79167 1.64583 8.65625 2 8.65625C2.35417 8.65625 2.66667 8.79167 2.9375 9.0625C3.20833 9.33333 3.34375 9.64583 3.34375 10C3.34375 10.3542 3.20833 10.6667 2.9375 10.9375C2.66667 11.2083 2.35417 11.3438 2 11.3438C1.64583 11.3438 1.33333 11.2083 1.0625 10.9375C0.791667 10.6667 0.65625 10.3542 0.65625 10C0.65625 9.64583 0.791667 9.33333 1.0625 9.0625ZM1.0625 5.0625C1.33333 4.79167 1.64583 4.65625 2 4.65625C2.35417 4.65625 2.66667 4.79167 2.9375 5.0625C3.20833 5.33333 3.34375 5.64583 3.34375 6C3.34375 6.35417 3.20833 6.66667 2.9375 6.9375C2.66667 7.20833 2.35417 7.34375 2 7.34375C1.64583 7.34375 1.33333 7.20833 1.0625 6.9375C0.791667 6.66667 0.65625 6.35417 0.65625 6C0.65625 5.64583 0.791667 5.33333 1.0625 5.0625ZM2.9375 2.9375C2.66667 3.20833 2.35417 3.34375 2 3.34375C1.64583 3.34375 1.33333 3.20833 1.0625 2.9375C0.791667 2.66667 0.65625 2.35417 0.65625 2C0.65625 1.64583 0.791667 1.33333 1.0625 1.0625C1.33333 0.791667 1.64583 0.65625 2 0.65625C2.35417 0.65625 2.66667 0.791667 2.9375 1.0625C3.20833 1.33333 3.34375 1.64583 3.34375 2C3.34375 2.35417 3.20833 2.66667 2.9375 2.9375Z"
            fill="white"
          />
        </svg>
      </button>
    </div>
    <div class="dialog__chat" #chatContainer>
      <div class="dialog__chat-one">
        <div class="date">Сегодня</div>
        <div class="chats">
          <div
            *ngFor="let message of messages"
            [class.chats__left]="!isMyMessage(message)"
            [class.chats__right]="isMyMessage(message)"
          >
            <div class="avatar" *ngIf="!isMyMessage(message)">
              <img [src]="getChatAvatar(selectedChat)" alt="avatar" />
            </div>
            <div class="user__inform">
              <div class="user__inform-title">
                {{ isMyMessage(message) ? "Вы" : getChatTitle(selectedChat) }}
                <span>{{ formatDate(message.createdAt) }}</span>
                <span class="read-status" *ngIf="isMyMessage(message)">
                  {{ message.isRead ? "✓✓" : "✓" }}
                </span>
              </div>
              <div
                [class.text]="!isMyMessage(message)"
                [class.text_right]="isMyMessage(message)"
              >
                {{ message.content }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="dialog__chat-input">
        <input
          type="text"
          placeholder="Type a message..."
          [(ngModel)]="newMessage"
          (keyup.enter)="sendMessage()"
        />
        <button (click)="sendMessage()" [disabled]="!newMessage.trim()">
          <svg width="15" height="12" viewBox="0 0 15 12">
            <path
              d="M0.34375 12V7.25L10.25 6L0.34375 4.75V0L14.25 6L0.34375 12Z"
              fill="#4a90e2"
            />
          </svg>
        </button>
      </div>
    </div>
  </div>
  <div class="chat__right empty" *ngIf="!selectedChat">
    <div class="empty-message">Выберите чат для начала общения</div>
  </div>
</div>
